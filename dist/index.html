<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music For Mom</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    h1 { color: #333; text-align: center; margin-bottom: 8px; font-size: 26px; }
    .subtitle { color: #666; text-align: center; margin-bottom: 20px; font-size: 14px; }
    .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; flex-wrap: wrap; }
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 16px; }
    label { display: block; color: #333; font-weight: 600; margin-bottom: 6px; font-size: 13px; }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus { outline: none; border-color: #667eea; }
    input.drag-over { border-color: #667eea; background: #f0f4ff; }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-row { display: flex; gap: 10px; }
    .user-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .user-status.logged-in { background: #d4edda; }
    .playlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .playlist-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    .playlist-card:hover { border-color: #667eea; transform: translateY(-2px); }
    .playlist-card img { width: 100%; height: 100px; object-fit: cover; background: #f0f0f0; }
    .playlist-card .info { padding: 10px; }
    .playlist-card .title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .playlist-card .count { color: #666; font-size: 11px; }
    .videos-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .back-btn { display: flex; align-items: center; gap: 6px; color: #667eea; cursor: pointer; font-size: 14px; }
    .video-list { max-height: 350px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; }
    .video-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #f0f0f0; }
    .video-item:last-child { border-bottom: none; }
    .video-item input[type="checkbox"] { width: 16px; height: 16px; }
    .video-item img { width: 60px; height: 34px; object-fit: cover; border-radius: 4px; background: #f0f0f0; }
    .video-item .video-info { flex: 1; min-width: 0; }
    .video-item .video-title { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .video-item .video-channel { font-size: 10px; color: #666; }
    .select-actions { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .select-actions button { font-size: 11px; padding: 5px 10px; }
    .folder-select { display: flex; gap: 8px; }
    .folder-select input { flex: 1; }
    .quick-drives { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .drive-btn {
      padding: 5px 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
    }
    .drive-btn:hover { background: #e0e0e0; }
    .progress-container { margin-top: 16px; display: none; }
    .progress-container.visible { display: block; }
    .progress-bar { height: 14px; background: #e0e0e0; border-radius: 7px; overflow: hidden; }
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text { text-align: center; margin-top: 6px; color: #666; font-size: 12px; }
    .status { padding: 12px; border-radius: 8px; margin-top: 12px; display: none; font-size: 13px; }
    .status.success { display: block; background: #d4edda; color: #155724; }
    .status.error { display: block; background: #f8d7da; color: #721c24; }
    .status.warning { display: block; background: #fff3cd; color: #856404; }
    .help-text { font-size: 11px; color: #888; margin-top: 4px; }
    .loading { text-align: center; padding: 30px; color: #666; }
    .empty-state { text-align: center; padding: 30px; color: #666; }
    .settings-section { background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .settings-section h3 { font-size: 14px; margin-bottom: 12px; color: #333; }
    .history-list { max-height: 400px; overflow-y: auto; }
    .history-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    .history-item:last-child { border-bottom: none; }
    .history-item .title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .history-item .date { color: #888; font-size: 11px; margin-left: 10px; }
    .download-actions { display: flex; gap: 8px; margin-top: 12px; }
    .download-actions button { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Music For Mom</h1>
    <p class="subtitle">Download YouTube music to your USB drive</p>

    <div id="ytdlp-warning" class="status warning" style="display: none;">
      yt-dlp is not installed. Please install it first.
    </div>
    <div id="ffmpeg-warning" class="status warning" style="display: none;">
      FFmpeg is not installed. Required for MP3 conversion.
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="download">Download</button>
      <button class="tab" data-tab="playlists">My Playlists</button>
      <button class="tab" data-tab="history">History</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>

    <!-- Download Tab -->
    <div id="download-tab" class="tab-content active">
      <form id="download-form">
        <div class="form-group">
          <label for="url">YouTube Link</label>
          <input type="text" id="url" placeholder="Paste or drag YouTube link here...">
          <p class="help-text">Drag & drop a link, or paste it. Works with songs, playlists, albums.</p>
        </div>

        <div class="form-group">
          <label for="output-dir">Save To</label>
          <div class="folder-select">
            <input type="text" id="output-dir" placeholder="Select folder..." readonly>
            <button type="button" id="browse-btn" class="btn btn-secondary">Browse</button>
          </div>
          <div id="quick-drives" class="quick-drives"></div>
        </div>

        <div class="download-actions">
          <button type="submit" class="btn btn-primary" id="download-btn">Download Music</button>
          <button type="button" class="btn btn-danger" id="cancel-btn" style="display: none;">Cancel</button>
        </div>
      </form>

      <div id="progress" class="progress-container">
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
        <p id="progress-text" class="progress-text">Starting...</p>
      </div>

      <div id="status" class="status"></div>
    </div>

    <!-- Playlists Tab -->
    <div id="playlists-tab" class="tab-content">
      <div id="auth-section">
        <div id="user-status" class="user-status">
          <span id="auth-message">Not logged in</span>
          <button id="login-btn" class="btn btn-primary">Login with Google</button>
        </div>
      </div>

      <div id="playlists-view">
        <div id="playlists-loading" class="loading" style="display: none;">Loading your playlists...</div>
        <div id="playlists-empty" class="empty-state" style="display: none;">Login to see your YouTube playlists</div>
        <div id="playlist-grid" class="playlist-grid"></div>
      </div>

      <div id="videos-view" style="display: none;">
        <div class="videos-header">
          <div class="back-btn" id="back-to-playlists">← Back</div>
          <h3 id="playlist-title" style="font-size: 14px;"></h3>
        </div>

        <div class="form-group">
          <label>Save To</label>
          <div class="folder-select">
            <input type="text" id="playlist-output-dir" placeholder="Select folder..." readonly>
            <button type="button" id="playlist-browse-btn" class="btn btn-secondary">Browse</button>
          </div>
          <div id="playlist-quick-drives" class="quick-drives"></div>
        </div>

        <div class="select-actions">
          <button class="btn btn-secondary" id="select-all-btn">All</button>
          <button class="btn btn-secondary" id="select-none-btn">None</button>
          <span id="selected-count" style="margin-left: auto; color: #666; font-size: 12px;">0 selected</span>
        </div>

        <div id="video-list" class="video-list"></div>

        <div class="download-actions" style="margin-top: 12px;">
          <button id="download-selected-btn" class="btn btn-primary">Download Selected</button>
          <button id="cancel-playlist-btn" class="btn btn-danger" style="display: none;">Cancel</button>
        </div>

        <div id="playlist-progress" class="progress-container">
          <div class="progress-bar">
            <div id="playlist-progress-fill" class="progress-fill"></div>
          </div>
          <p id="playlist-progress-text" class="progress-text">Starting...</p>
        </div>

        <div id="playlist-status" class="status"></div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="history-tab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="font-size: 14px; color: #333;">Recent Downloads</h3>
        <button id="clear-history-btn" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">Clear History</button>
      </div>
      <div id="history-list" class="history-list">
        <div class="empty-state">No downloads yet</div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="settings-section">
        <h3>YouTube API Configuration</h3>
        <p class="help-text" style="margin-bottom: 12px;">
          To browse your playlists, set up YouTube API credentials.
          <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Get credentials here</a>
        </p>
        <div class="form-group">
          <label for="client-id">Client ID</label>
          <input type="text" id="client-id" placeholder="Your OAuth Client ID">
        </div>
        <div class="form-group">
          <label for="client-secret">Client Secret</label>
          <input type="password" id="client-secret" placeholder="Your OAuth Client Secret">
        </div>
        <button id="save-config-btn" class="btn btn-primary">Save Configuration</button>
      </div>

      <div class="settings-section">
        <h3>Account</h3>
        <div id="settings-auth-status" class="user-status">
          <span>Not logged in</span>
        </div>
        <button id="settings-logout-btn" class="btn btn-danger" style="display: none;">Logout</button>
      </div>

      <div class="settings-section">
        <h3>Maintenance</h3>
        <p class="help-text" style="margin-bottom: 12px;">Keep yt-dlp updated for best compatibility with YouTube.</p>
        <button id="update-ytdlp-btn" class="btn btn-secondary">Update yt-dlp</button>
        <div id="update-status" class="status" style="margin-top: 8px;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    const { invoke } = window.__TAURI__.core;
    const { listen } = window.__TAURI__.event;
    const { open } = window.__TAURI__.dialog;

    let isLoggedIn = false;
    let isDownloading = false;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
        if (tabId === 'playlists') checkAuthAndLoadPlaylists();
        if (tabId === 'history') loadHistory();
      });
    });

    // Drag and drop for URL input
    const urlInput = document.getElementById('url');
    urlInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      urlInput.classList.add('drag-over');
    });
    urlInput.addEventListener('dragleave', () => urlInput.classList.remove('drag-over'));
    urlInput.addEventListener('drop', (e) => {
      e.preventDefault();
      urlInput.classList.remove('drag-over');
      const text = e.dataTransfer.getData('text');
      if (text && (text.includes('youtube.com') || text.includes('youtu.be'))) {
        urlInput.value = text;
      }
    });

    // Check dependencies
    async function checkDependencies() {
      try {
        if (!(await invoke('check_ytdlp'))) document.getElementById('ytdlp-warning').style.display = 'block';
      } catch { document.getElementById('ytdlp-warning').style.display = 'block'; }
      try {
        if (!(await invoke('check_ffmpeg'))) document.getElementById('ffmpeg-warning').style.display = 'block';
      } catch { document.getElementById('ffmpeg-warning').style.display = 'block'; }
    }

    // Load saved config
    async function loadSavedConfig() {
      try {
        const config = await invoke('get_youtube_config');
        if (config.client_id) document.getElementById('client-id').value = config.client_id;
        if (config.client_secret) document.getElementById('client-secret').value = '••••••••••••••••';
      } catch {}
    }

    // Load drives
    async function loadDrives() {
      try {
        const drives = await invoke('list_drives');
        ['quick-drives', 'playlist-quick-drives'].forEach(id => {
          const container = document.getElementById(id);
          container.innerHTML = drives.length === 0
            ? '<span class="help-text">No USB drives detected</span>'
            : drives.map(d => `<button type="button" class="drive-btn" data-path="${d.path}">${d.name}</button>`).join('');
          container.querySelectorAll('.drive-btn').forEach(btn => {
            btn.onclick = () => document.getElementById(id === 'quick-drives' ? 'output-dir' : 'playlist-output-dir').value = btn.dataset.path;
          });
        });
      } catch {}
    }

    // Browse buttons
    document.getElementById('browse-btn').onclick = async () => {
      const selected = await open({ directory: true });
      if (selected) document.getElementById('output-dir').value = selected;
    };
    document.getElementById('playlist-browse-btn').onclick = async () => {
      const selected = await open({ directory: true });
      if (selected) document.getElementById('playlist-output-dir').value = selected;
    };

    // Download form
    document.getElementById('download-form').onsubmit = async (e) => {
      e.preventDefault();
      const url = document.getElementById('url').value.trim();
      const outputDir = document.getElementById('output-dir').value.trim();
      if (!url || !outputDir) return showStatus('status', 'error', 'Please fill in all fields');

      setDownloading(true);
      try {
        await invoke('download_audio', { url, outputDir });
      } catch (error) {
        showStatus('status', 'error', error);
      }
      setDownloading(false);
    };

    // Cancel buttons
    document.getElementById('cancel-btn').onclick = async () => {
      await invoke('cancel_download');
      showStatus('status', 'warning', 'Download cancelled');
      setDownloading(false);
    };
    document.getElementById('cancel-playlist-btn').onclick = async () => {
      await invoke('cancel_download');
      showStatus('playlist-status', 'warning', 'Download cancelled');
      setDownloading(false, 'playlist');
    };

    function setDownloading(downloading, prefix = '') {
      isDownloading = downloading;
      const downloadBtn = document.getElementById(prefix ? 'download-selected-btn' : 'download-btn');
      const cancelBtn = document.getElementById(prefix ? 'cancel-playlist-btn' : 'cancel-btn');
      const progress = document.getElementById(`${prefix}${prefix ? '-' : ''}progress`);

      downloadBtn.disabled = downloading;
      downloadBtn.textContent = downloading ? 'Downloading...' : (prefix ? 'Download Selected' : 'Download Music');
      cancelBtn.style.display = downloading ? 'block' : 'none';

      if (downloading) {
        document.getElementById(`${prefix}${prefix ? '-' : ''}status`).style.display = 'none';
        document.getElementById(`${prefix}${prefix ? '-' : ''}progress-fill`).style.width = '0%';
        progress.classList.add('visible');
      }
    }

    // Progress listener
    listen('download-progress', (event) => {
      const { status, message, percent } = event.payload;
      ['', 'playlist-'].forEach(prefix => {
        const fill = document.getElementById(`${prefix}progress-fill`);
        const text = document.getElementById(`${prefix}progress-text`);
        const container = document.getElementById(`${prefix}progress`);
        if (fill && text && container) {
          container.classList.add('visible');
          text.textContent = message;
          if (percent !== null) fill.style.width = `${percent}%`;
        }
      });
      if (status === 'complete') {
        showStatus('status', 'success', message);
        showStatus('playlist-status', 'success', message);
        setDownloading(false);
        setDownloading(false, 'playlist');
      } else if (status === 'cancelled') {
        setDownloading(false);
        setDownloading(false, 'playlist');
      }
    });

    // History
    async function loadHistory() {
      try {
        const history = await invoke('get_history');
        const list = document.getElementById('history-list');
        if (history.length === 0) {
          list.innerHTML = '<div class="empty-state">No downloads yet</div>';
        } else {
          list.innerHTML = history.map(h => `
            <div class="history-item">
              <span class="title">${escapeHtml(h.title)}</span>
              <span class="date">${new Date(h.timestamp * 1000).toLocaleDateString()}</span>
            </div>
          `).join('');
        }
      } catch {}
    }

    document.getElementById('clear-history-btn').onclick = async () => {
      await invoke('clear_history');
      loadHistory();
    };

    // Auth
    async function checkAuthAndLoadPlaylists() {
      try {
        isLoggedIn = await invoke('get_auth_status');
        updateAuthUI();
        if (isLoggedIn) await loadPlaylists();
      } catch {}
    }

    function updateAuthUI() {
      const elements = {
        userStatus: document.getElementById('user-status'),
        authMessage: document.getElementById('auth-message'),
        loginBtn: document.getElementById('login-btn'),
        settingsStatus: document.getElementById('settings-auth-status'),
        logoutBtn: document.getElementById('settings-logout-btn'),
        empty: document.getElementById('playlists-empty'),
        grid: document.getElementById('playlist-grid')
      };

      if (isLoggedIn) {
        elements.userStatus.classList.add('logged-in');
        elements.authMessage.textContent = 'Logged in to YouTube';
        elements.loginBtn.style.display = 'none';
        elements.settingsStatus.innerHTML = '<span>Logged in to YouTube</span>';
        elements.settingsStatus.classList.add('logged-in');
        elements.logoutBtn.style.display = 'block';
        elements.empty.style.display = 'none';
      } else {
        elements.userStatus.classList.remove('logged-in');
        elements.authMessage.textContent = 'Not logged in';
        elements.loginBtn.style.display = 'block';
        elements.settingsStatus.innerHTML = '<span>Not logged in</span>';
        elements.settingsStatus.classList.remove('logged-in');
        elements.logoutBtn.style.display = 'none';
        elements.empty.style.display = 'block';
        elements.grid.innerHTML = '';
      }
    }

    document.getElementById('login-btn').onclick = async () => {
      try {
        await invoke('start_oauth');
        document.getElementById('auth-message').textContent = 'Waiting for login...';
        if (await invoke('wait_for_oauth_callback')) {
          isLoggedIn = true;
          updateAuthUI();
          await loadPlaylists();
        }
      } catch (e) { showStatus('playlist-status', 'error', e); }
    };

    document.getElementById('settings-logout-btn').onclick = async () => {
      await invoke('logout');
      isLoggedIn = false;
      updateAuthUI();
    };

    // Playlists
    async function loadPlaylists() {
      const grid = document.getElementById('playlist-grid');
      document.getElementById('playlists-loading').style.display = 'block';
      grid.innerHTML = '';
      try {
        const playlists = await invoke('get_my_playlists');
        grid.innerHTML = playlists.map(pl => `
          <div class="playlist-card" data-id="${pl.id}" data-title="${escapeHtml(pl.title)}">
            <img src="${pl.thumbnail || ''}" alt="" onerror="this.style.background='#e0e0e0'">
            <div class="info">
              <div class="title">${escapeHtml(pl.title)}</div>
              <div class="count">${pl.video_count} videos</div>
            </div>
          </div>
        `).join('');
        grid.querySelectorAll('.playlist-card').forEach(card => {
          card.onclick = () => openPlaylist(card.dataset.id, card.dataset.title);
        });
      } catch (e) { showStatus('playlist-status', 'error', e); }
      document.getElementById('playlists-loading').style.display = 'none';
    }

    async function openPlaylist(playlistId, title) {
      document.getElementById('playlists-view').style.display = 'none';
      document.getElementById('videos-view').style.display = 'block';
      document.getElementById('playlist-title').textContent = title;

      const videoList = document.getElementById('video-list');
      videoList.innerHTML = '<div class="loading">Loading videos...</div>';

      try {
        const videos = await invoke('get_playlist_videos', { playlistId });
        videoList.innerHTML = videos.map(v => `
          <div class="video-item">
            <input type="checkbox" data-id="${v.id}" checked>
            <img src="${v.thumbnail || ''}" alt="">
            <div class="video-info">
              <div class="video-title">${escapeHtml(v.title)}</div>
              <div class="video-channel">${escapeHtml(v.channel)}</div>
            </div>
          </div>
        `).join('');
        updateSelectedCount();
        videoList.querySelectorAll('input').forEach(cb => cb.onchange = updateSelectedCount);
      } catch (e) { videoList.innerHTML = `<div class="empty-state">Error: ${e}</div>`; }
    }

    function updateSelectedCount() {
      document.getElementById('selected-count').textContent =
        `${document.querySelectorAll('#video-list input:checked').length} selected`;
    }

    document.getElementById('back-to-playlists').onclick = () => {
      document.getElementById('playlists-view').style.display = 'block';
      document.getElementById('videos-view').style.display = 'none';
    };
    document.getElementById('select-all-btn').onclick = () => {
      document.querySelectorAll('#video-list input').forEach(cb => cb.checked = true);
      updateSelectedCount();
    };
    document.getElementById('select-none-btn').onclick = () => {
      document.querySelectorAll('#video-list input').forEach(cb => cb.checked = false);
      updateSelectedCount();
    };

    document.getElementById('download-selected-btn').onclick = async () => {
      const outputDir = document.getElementById('playlist-output-dir').value.trim();
      if (!outputDir) return showStatus('playlist-status', 'error', 'Please select a folder');

      const selectedIds = Array.from(document.querySelectorAll('#video-list input:checked')).map(cb => cb.dataset.id);
      if (selectedIds.length === 0) return showStatus('playlist-status', 'error', 'No videos selected');

      setDownloading(true, 'playlist');
      try {
        await invoke('download_videos', { videoIds: selectedIds, outputDir });
      } catch (e) { showStatus('playlist-status', 'error', e); }
      setDownloading(false, 'playlist');
    };

    // Settings
    document.getElementById('save-config-btn').onclick = async () => {
      const clientId = document.getElementById('client-id').value.trim();
      const clientSecret = document.getElementById('client-secret').value.trim();
      if (!clientId || !clientSecret) return alert('Please enter both Client ID and Client Secret');
      try {
        await invoke('set_youtube_config', { clientId, clientSecret });
        alert('Configuration saved!');
      } catch (e) { alert('Error: ' + e); }
    };

    document.getElementById('update-ytdlp-btn').onclick = async () => {
      const btn = document.getElementById('update-ytdlp-btn');
      btn.disabled = true;
      btn.textContent = 'Updating...';
      try {
        const result = await invoke('update_ytdlp');
        showStatus('update-status', 'success', 'Updated successfully!');
      } catch (e) {
        showStatus('update-status', 'error', e);
      }
      btn.disabled = false;
      btn.textContent = 'Update yt-dlp';
    };

    // Helpers
    function showStatus(id, type, message) {
      const el = document.getElementById(id);
      el.className = `status ${type}`;
      el.textContent = message;
      el.style.display = 'block';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Init
    checkDependencies();
    loadDrives();
    loadSavedConfig();
    setInterval(loadDrives, 5000);
  </script>
</body>
</html>
